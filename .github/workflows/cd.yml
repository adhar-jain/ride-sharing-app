name: RS app deployment 

on: 
   workflow_run:
    workflows: ["CI Workflow"]  # Must match `name:` in ci.yml
    types:
      - completed
   workflow_dispatch: # Allows manual triggering of the workflow

permissions:
  contents: write 
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy ride sharing app to gh pages
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps: 
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Install dependencies and build the project
      - name: Install dependencies and build
        run: |
          npm install
          npm run build

      # Deploy to gh-pages branch
      - name: Deploy to gh-pages
        run: |
          git config --global user.email "adharjain@gmail.com"
          git config --global user.name "adhar-jain"
          # Check if remote origin already exists
          if git remote get-url origin; then
            git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}
          else
            git remote add origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}
          fi
          git checkout --orphan gh-pages
          rm -rf .gitignore
          cp -r dist/ride-sharing-app/* .
          git add -A
          git commit -m "Deploy to GitHub Pages - $(date)"
          git push -f origin gh-pages